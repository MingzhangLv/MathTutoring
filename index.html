<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åˆä¸­æ•°å­¦ä½œä¸šè¾…å¯¼</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      :root {
        color-scheme: light;
        --bg: #f5f7fa;
        --panel: rgba(255, 255, 255, 0.75);
        --panel-2: rgba(255, 255, 255, 0.9);
        --text: #1a202c;
        --muted: #64748b;
        --border: rgba(0, 0, 0, 0.08);
        --accent: #6366f1;
        --accent-2: #0d9488;
        --danger: #ef4444;
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        --radius: 16px;
        --radius-2: 12px;
        --max: 1020px;
        --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family: var(--font);
        background:
          radial-gradient(1200px 700px at 20% 10%, rgba(99, 102, 241, 0.08), transparent 60%),
          radial-gradient(900px 600px at 85% 25%, rgba(13, 148, 136, 0.08), transparent 55%),
          radial-gradient(1200px 800px at 50% 120%, rgba(239, 68, 68, 0.05), transparent 60%),
          var(--bg);
        color: var(--text);
      }

      a {
        color: inherit;
      }

      .container {
        max-width: var(--max);
        margin: 0 auto;
        padding: 28px 18px 24px;
        display: grid;
        gap: 16px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px 18px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
        box-shadow: var(--shadow);
        backdrop-filter: blur(12px);
      }

      .brand {
        display: grid;
        gap: 4px;
        min-width: 240px;
      }

      .brand h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.2px;
      }

      .brand p {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
        line-height: 1.3;
      }

      .actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
        color: var(--muted);
        font-size: 12px;
        user-select: none;
      }

      .btn {
        appearance: none;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        border-radius: 999px;
        padding: 10px 12px;
        font-size: 12px;
        line-height: 1;
        cursor: pointer;
        transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      }

      .btn:hover {
        transform: translateY(-1px);
        border-color: rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.09);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn-danger {
        border-color: rgba(251, 113, 133, 0.45);
        background: rgba(251, 113, 133, 0.14);
      }

      .btn-primary {
        border-color: rgba(124, 92, 255, 0.55);
        background: rgba(124, 92, 255, 0.18);
      }

      .layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        align-items: start;
      }

      @media (max-width: 920px) {
        .layout {
          grid-template-columns: 1fr;
        }
      }

      .card {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: rgba(255, 255, 255, 0.04);
        box-shadow: var(--shadow);
        backdrop-filter: blur(12px);
        overflow: hidden;
      }

      .chat {
        display: grid;
        grid-template-rows: auto 1fr auto;
        height: calc(100vh - 140px);
        min-height: 500px;
      }

      .chat-header {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .chat-header strong {
        font-size: 14px;
        letter-spacing: 0.2px;
      }

      .chat-header span {
        color: var(--muted);
        font-size: 12px;
      }

      .messages {
        padding: 14px 14px 18px;
        overflow: auto;
        scroll-behavior: smooth;
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.1) transparent;
      }

      .messages::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      .messages::-webkit-scrollbar-track {
        background: transparent;
      }

      .messages::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 99px;
      }

      .messages::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.2);
      }

      .messages-inner {
        display: grid;
        gap: 10px;
      }

      .msg {
        display: grid;
        gap: 6px;
        max-width: 92%;
      }

      .msg .meta {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--muted);
        font-size: 12px;
      }

      .bubble {
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 12px 12px;
        background: #ffffff;
        line-height: 1.55;
        /* white-space: pre-wrap; removed for markdown */
        word-break: break-word;
      }

      .bubble h1, .bubble h2, .bubble h3, .bubble h4 {
        margin: 0.5em 0 0.3em;
        line-height: 1.3;
      }
      .bubble h1 { font-size: 1.4em; }
      .bubble h2 { font-size: 1.25em; }
      .bubble h3 { font-size: 1.1em; }
      .bubble p { margin: 0.5em 0; }
      .bubble p:first-child { margin-top: 0; }
      .bubble p:last-child { margin-bottom: 0; }
      .bubble ul, .bubble ol { margin: 0.5em 0; padding-left: 1.4em; }
      .bubble code {
        background: rgba(0,0,0,0.06);
        padding: 2px 4px;
        border-radius: 4px;
        font-family: monospace;
        color: #0f172a;
      }
      .bubble pre {
        background: #f1f5f9;
        padding: 10px;
        border-radius: 8px;
        overflow-x: auto;
        border: 1px solid var(--border);
      }
      .bubble pre code { background: none; padding: 0; color: inherit; }
      .bubble blockquote {
        margin: 0.5em 0;
        padding-left: 10px;
        border-left: 3px solid var(--accent);
        color: var(--muted);
      }

      .msg.user {
        justify-self: end;
      }

      .msg.user .bubble {
        background: #e0e7ff;
        border-color: #c7d2fe;
        color: #1e1b4b;
        border-bottom-right-radius: 4px;
      }

      .msg.assistant .bubble {
        background: #ffffff;
        border-color: var(--border);
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        border-bottom-left-radius: 4px;
      }

      .composer {
        border-top: 1px solid var(--border);
        padding: 12px;
        display: grid;
        gap: 10px;
        background: rgba(255, 255, 255, 0.03);
      }

      .quick {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .chip {
        border: 1px solid var(--border);
        background: #ffffff;
        color: var(--text);
        border-radius: 999px;
        padding: 8px 10px;
        font-size: 12px;
        cursor: pointer;
        transition: background 120ms ease, transform 120ms ease;
      }

      .chip:hover {
        transform: translateY(-1px);
        background: #f1f5f9;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: end;
      }

      .input {
        width: 100%;
        min-height: 44px;
        max-height: 160px;
        resize: none;
        border-radius: var(--radius-2);
        border: 1px solid var(--border);
        background: #ffffff;
        color: var(--text);
        padding: 12px 12px;
        font-size: 14px;
        line-height: 1.45;
        outline: none;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none;  /* IE 10+ */
      }
      
      .input::-webkit-scrollbar {
        display: none; /* Chrome/Safari */
      }

      .input:focus {
        border-color: rgba(124, 92, 255, 0.6);
        box-shadow: 0 0 0 4px rgba(124, 92, 255, 0.16);
      }

      .send {
        height: 44px;
        padding: 0 14px;
        border-radius: 12px;
        border: 1px solid rgba(124, 92, 255, 0.55);
        background: rgba(124, 92, 255, 0.22);
        color: var(--text);
        font-weight: 600;
        cursor: pointer;
        transition: transform 120ms ease, background 120ms ease;
      }

      .send:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .send:hover:not(:disabled) {
        transform: translateY(-1px);
        background: rgba(124, 92, 255, 0.28);
      }

      .hint {
        color: var(--muted);
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }

      .side {
        padding: 14px 14px 16px;
        display: grid;
        gap: 12px;
      }

      .side h2 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.2px;
      }

      .side p {
        margin: 0;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.55;
      }

      .list {
        display: grid;
        gap: 10px;
      }

      .item {
        border: 1px solid var(--border);
        border-radius: var(--radius-2);
        background: #ffffff;
        padding: 12px;
        display: grid;
        gap: 6px;
      }

      .item strong {
        font-size: 13px;
      }

      .item span {
        color: var(--muted);
        font-size: 12px;
        line-height: 1.5;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <header class="topbar">
        <div class="brand">
          <h1>åˆä¸­æ•°å­¦ä½œä¸šè¾…å¯¼</h1>
          <p>æŠŠé¢˜ç›®å‘å‡ºæ¥ï¼Œæˆ‘ç”¨åˆ†æ­¥æ–¹å¼å¸®ä½ ç†æ¸…æ€è·¯ã€‚</p>
        </div>
        <div class="actions">
          <div class="pill" id="statusPill">ç¦»çº¿æ¼”ç¤ºæ¨¡å¼</div>
          <button class="btn btn-primary" id="scrollToBottomBtn" type="button">å›åˆ°åº•éƒ¨</button>
          <button class="btn btn-danger" id="clearBtn" type="button">æ¸…ç©ºå¯¹è¯</button>
        </div>
      </header>

      <section class="layout">
        <section class="card chat" aria-label="å¯¹è¯åŒº">
          <div class="chat-header">
            <div style="display: grid; gap: 2px">
              <strong>è¾…å¯¼å¯¹è¯</strong>
              <span>æ”¯æŒ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ</span>
            </div>
            <span id="counter">0 æ¡æ¶ˆæ¯</span>
          </div>

          <div class="messages" id="messages" role="log" aria-live="polite">
            <div class="messages-inner" id="messagesInner"></div>
          </div>

          <div class="composer">
            <div class="quick" aria-label="å¿«æ·æé—®">
              <button class="chip" data-prompt="å·²çŸ¥ä¸€æ¬¡å‡½æ•° y=2x+1ï¼Œæ±‚ x=3 æ—¶ y çš„å€¼">ä¸€æ¬¡å‡½æ•°ä»£å…¥</button>
              <button class="chip" data-prompt="è§£æ–¹ç¨‹ï¼š2(x-3)=x+5">è§£æ–¹ç¨‹</button>
              <button class="chip" data-prompt="è®¡ç®—ï¼š(-3)^2 - 2Ã—( -4 )">æœ‰ç†æ•°è¿ç®—</button>
              <button class="chip" data-prompt="å·²çŸ¥ä¸‰è§’å½¢ä¸¤è¾¹ 5 å’Œ 7ï¼Œç¬¬ä¸‰è¾¹å–å€¼èŒƒå›´ï¼Ÿ">ä¸‰è§’å½¢ä¸ç­‰å¼</button>
            </div>

            <div class="row">
              <label class="sr-only" for="input">è¾“å…¥ä½ çš„æ•°å­¦é—®é¢˜</label>
              <textarea
                id="input"
                class="input"
                placeholder="ä¾‹å¦‚ï¼šè§£æ–¹ç¨‹ 3x-5=2x+7ï¼Œè¦æ±‚å†™å‡ºæ­¥éª¤"
                rows="1"
              ></textarea>
              <button id="sendBtn" class="send" type="button" disabled>å‘é€</button>
            </div>

            <div class="hint">
              <span>å»ºè®®ï¼šå‘é¢˜ç›®+ä½ å¡ä½çš„æ­¥éª¤+æ˜¯å¦éœ€è¦ç­”æ¡ˆ/åªè¦æ€è·¯</span>
              <span id="draftHint">æœªè¾“å…¥</span>
            </div>
          </div>
        </section>
      </section>
    </main>

    <script>
      const STORAGE_KEY = "math_tutoring_chat_v1";

      const els = {
        messages: document.getElementById("messages"),
        messagesInner: document.getElementById("messagesInner"),
        input: document.getElementById("input"),
        sendBtn: document.getElementById("sendBtn"),
        clearBtn: document.getElementById("clearBtn"),
        counter: document.getElementById("counter"),
        draftHint: document.getElementById("draftHint"),
        scrollToBottomBtn: document.getElementById("scrollToBottomBtn"),
        statusPill: document.getElementById("statusPill"),
      };

      let backendAvailable = false;

      function nowTime() {
        const d = new Date();
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${hh}:${mm}`;
      }

      function escapeText(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.textContent || "";
      }

      function makeMessage(role, text) {
        return {
          id:
            typeof crypto !== "undefined" && typeof crypto.randomUUID === "function"
              ? crypto.randomUUID()
              : String(Date.now() + Math.random()),
          role,
          text,
          time: nowTime(),
        };
      }

      const DEFAULT_MESSAGES = [
        {
          id: "intro-1",
          role: "assistant",
          text: "åŒå­¦ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ä¸“å±æ•°å­¦è¾…å¯¼è€å¸ˆã€‚ğŸ‘‹\n\nä¸ç®¡æ˜¯ä»£æ•°è®¡ç®—ã€å‡ ä½•è¯æ˜ï¼Œè¿˜æ˜¯åº”ç”¨é¢˜ï¼Œé‡åˆ°ä¸ä¼šçš„éƒ½å¯ä»¥å‘ç»™æˆ‘ã€‚\n\n**æˆ‘ä¼šä¸€æ­¥æ­¥å¼•å¯¼ä½ è‡ªå·±è§£å‡ºæ¥ï¼Œè€Œä¸æ˜¯ç›´æ¥ç»™ä½ ç­”æ¡ˆå“¦ã€‚** è¯•è¯•æŠŠé¢˜ç›®å‘ç»™æˆ‘å§ï¼",
          time: nowTime(),
        },
        {
          id: "demo-user-1",
          role: "user",
          text: "è€å¸ˆï¼Œè§£æ–¹ç¨‹ 2x + 5 = 13 æ€ä¹ˆåšï¼Ÿ",
          time: nowTime(),
        },
        {
          id: "demo-assistant-1",
          role: "assistant",
          text: "æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ã€‚è¿™é“é¢˜çš„ç›®æ ‡æ˜¯æ±‚å‡º x çš„å€¼ã€‚\n\nä¸ºäº†è®© x å•ç‹¬ç•™åœ¨ç­‰å·ä¸€è¾¹ï¼Œä½ è§‰å¾—ç¬¬ä¸€æ­¥åº”è¯¥å…ˆæŠŠå“ªä¸ªæ•°ç§»èµ°ï¼Ÿ",
          time: nowTime(),
        },
      ];

      function loadMessages() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return DEFAULT_MESSAGES;
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed) || parsed.length === 0) return DEFAULT_MESSAGES;
          return parsed
            .filter((m) => m && (m.role === "user" || m.role === "assistant") && typeof m.text === "string")
            .map((m) => ({
              id: typeof m.id === "string" ? m.id : String(Date.now() + Math.random()),
              role: m.role,
              text: m.text,
              time: typeof m.time === "string" ? m.time : nowTime(),
            }));
        } catch {
          return DEFAULT_MESSAGES;
        }
      }

      function saveMessages(messages) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
        } catch {
          return;
        }
      }

      function scrollToBottom() {
        els.messages.scrollTop = els.messages.scrollHeight;
      }

      function render(messages) {
        els.messagesInner.innerHTML = "";
        for (const m of messages) {
          const wrap = document.createElement("div");
          wrap.className = `msg ${m.role}`;

          const meta = document.createElement("div");
          meta.className = "meta";
          const who = document.createElement("span");
          who.textContent = m.role === "user" ? "ä½ " : "è¾…å¯¼è€å¸ˆ";
          const time = document.createElement("span");
          time.textContent = m.time;
          meta.appendChild(who);
          meta.appendChild(time);

          const bubble = document.createElement("div");
          bubble.className = "bubble";
          // Use marked to parse markdown if available, otherwise fallback to textContent
          if (typeof marked !== "undefined" && typeof marked.parse === "function") {
             bubble.innerHTML = marked.parse(m.text);
          } else {
             bubble.textContent = m.text;
          }

          wrap.appendChild(meta);
          wrap.appendChild(bubble);
          els.messagesInner.appendChild(wrap);
        }

        els.counter.textContent = `${messages.length} æ¡æ¶ˆæ¯`;
        requestAnimationFrame(scrollToBottom);
      }

      function autoGrow() {
        const el = els.input;
        el.style.height = "auto";
        el.style.height = Math.min(el.scrollHeight, 160) + "px";
      }

      function canSend() {
        return els.input.value.trim().length > 0;
      }

      function updateComposer() {
        els.sendBtn.disabled = !canSend();
        const v = els.input.value.trim();
        els.draftHint.textContent = v ? `è‰ç¨¿ï¼š${Math.min(v.length, 80)} å­—ç¬¦` : "æœªè¾“å…¥";
        autoGrow();
      }

      function splitMathHint(text) {
        const t = text.trim();
        const hasEq = /[=]/.test(t);
        const hasX = /[a-zA-Z]/.test(t);
        const hasParen = /[()ï¼ˆï¼‰]/.test(t);
        const hasNeg = /-/.test(t);
        const focus = [];
        if (hasEq && hasX) focus.push("å…ˆæŠŠå«æœªçŸ¥æ•°çš„é¡¹ç§»åˆ°ä¸€è¾¹ï¼Œå¸¸æ•°é¡¹ç§»åˆ°å¦ä¸€è¾¹");
        if (hasParen) focus.push("æ³¨æ„å»æ‹¬å·ï¼šåˆ†é…å¾‹ï¼Œæ‹¬å·å‰æ˜¯è´Ÿå·è¦å˜å·");
        if (hasNeg) focus.push("æœ‰ç†æ•°è¿ç®—å…ˆå¤„ç†ç¬¦å·ï¼Œå†ç®—ç»å¯¹å€¼");
        if (!focus.length) focus.push("æŠŠå·²çŸ¥æ¡ä»¶åˆ—æˆå¼å­ï¼Œå†æŒ‰æ­¥éª¤åŒ–ç®€/æ±‚è§£");
        return focus;
      }

      function buildTutorReply(userText) {
        const clean = escapeText(userText);
        const hints = splitMathHint(clean);
        const lines = [];
        lines.push("æˆ‘å…ˆæŒ‰æ­¥éª¤å¸¦ä½ åšï¼š");
        lines.push(`1ï¼‰å¤è¿°é¢˜æ„ï¼š${clean}`);
        lines.push("2ï¼‰å…³é”®æ–¹æ³•ï¼š");
        for (const h of hints) lines.push(`- ${h}`);
        lines.push("3ï¼‰ä½ å…ˆæŠŠç¬¬ä¸€æ­¥å†™å‡ºæ¥å‘æˆ‘ï¼Œæˆ‘å¸®ä½ æ£€æŸ¥å¹¶ç»§ç»­æ¨ä¸‹å»ã€‚");
        lines.push("å¦‚æœä½ æƒ³è¦ç›´æ¥ç­”æ¡ˆï¼Œä¹Ÿå¯ä»¥è¯´ï¼šè¦ç­”æ¡ˆ+æ­¥éª¤ã€‚");
        return lines.join("\n");
      }

      async function checkBackend() {
        els.statusPill.textContent = "æ­£åœ¨æ£€æµ‹åç«¯â€¦";
        try {
          const res = await fetch("/api/health", { method: "GET" });
          backendAvailable = res.ok;
        } catch {
          backendAvailable = false;
        }
        els.statusPill.textContent = backendAvailable ? "å·²è¿æ¥å¤§æ¨¡å‹åç«¯" : "ç¦»çº¿æ¼”ç¤ºæ¨¡å¼";
      }

      async function callBackendChat(allMessages) {
        const payloadMessages = allMessages
          .filter((m) => m && (m.role === "user" || m.role === "assistant"))
          .slice(-12)
          .map((m) => ({
            role: m.role === "assistant" ? "assistant" : "user",
            content: String(m.text || ""),
          }));

        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: payloadMessages }),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error((data && data.error) || "åç«¯è¯·æ±‚å¤±è´¥");
        }
        return String(data.reply || "");
      }

      function enqueueAssistant(userText) {
        const thinking = makeMessage("assistant", "æˆ‘åœ¨çœ‹é¢˜ç›®â€¦");
        // Append to global messages
        messages = [...messages, thinking];
        render(messages);
        saveMessages(messages);

        (async () => {
          let reply = "";
          if (backendAvailable) {
            try {
              // Exclude the thinking message from context
              const context = messages.filter((m) => m.id !== thinking.id);
              reply = await callBackendChat(context);
            } catch {
              backendAvailable = false;
              els.statusPill.textContent = "ç¦»çº¿æ¼”ç¤ºæ¨¡å¼";
              reply = buildTutorReply(userText);
            }
          } else {
            reply = buildTutorReply(userText);
          }

          // Update the thinking message in global messages
          messages = messages.map((m) => (m.id === thinking.id ? { ...m, text: reply, time: nowTime() } : m));
          render(messages);
          saveMessages(messages);
        })();
      }

      function send() {
        const text = els.input.value.trim();
        if (!text) return;
        els.input.value = "";
        updateComposer();
        
        const msg = makeMessage("user", text);
        messages = [...messages, msg];
        
        render(messages);
        saveMessages(messages);
        enqueueAssistant(text);
      }

      let messages = loadMessages();
      if (!messages.length) {
        // Fallback if loadMessages returns empty but not default (should rarely happen now)
        messages = DEFAULT_MESSAGES;
        saveMessages(messages);
      }

      render(messages);
      updateComposer();
      checkBackend();

      els.input.addEventListener("input", () => updateComposer());

      els.input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          send();
        }
      });

      els.sendBtn.addEventListener("click", () => {
        send();
      });

      els.clearBtn.addEventListener("click", () => {
        messages = [makeMessage("assistant", "å·²æ¸…ç©ºã€‚æŠŠæ–°é¢˜ç›®å‘æˆ‘ï¼Œæˆ‘ä»¬ä»å¤´å¼€å§‹ã€‚")];
        saveMessages(messages);
        render(messages);
      });

      els.scrollToBottomBtn.addEventListener("click", () => scrollToBottom());

      document.querySelectorAll(".chip[data-prompt]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const prompt = btn.getAttribute("data-prompt") || "";
          const nextValue = els.input.value ? `${els.input.value.trim()}\n${prompt}` : prompt;
          els.input.value = nextValue;
          updateComposer();
          els.input.focus();
        });
      });
    </script>
  </body>
</html>
